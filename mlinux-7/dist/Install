#!/bin/bash
# Installation script for webapi_example
# This script handles installation/removal of dependencies and firewall configuration

OPKG_CMD_PREFIX="opkg install --force-depends ./provisioning/"
OPKG_CMD_PREFIX_R="opkg remove --force-depends "
MANIFEST="./provisioning/p_manifest.json"
NAME="Install"

APP_DIR="${APP_DIR:-$(dirname "$0")}"
CONFIG_FILE="$APP_DIR/config/config.json"
DEFAULT_PORT=5000

# Install required packages from provisioning directory
function install_packages {
    logger -t Install "Installing webapi_example dependencies"
    
    if [ -f "$MANIFEST" ]; then
        JSONTXT=$(<./provisioning/p_manifest.json)
        PKGCNT=$(echo $JSONTXT | jsparser --count -p /pkgs 2>/dev/null)
        
        if [ -n "$PKGCNT" ] && [ "$PKGCNT" -gt 0 ]; then
            for ((i=0; i < PKGCNT; i++)); do
                PKG=$(echo $JSONTXT | jsparser --jsobj -p /pkgs/$i 2>/dev/null)
                PKGNM=$(echo $PKG | jsparser -p /FileName 2>/dev/null)
                PKGTYPE=$(echo $PKG | jsparser -p /type 2>/dev/null)
                
                if [ "$PKGTYPE" == "ipk" ] && [ -f "./provisioning/$PKGNM" ]; then
                    PKGCMD=$OPKG_CMD_PREFIX$PKGNM
                    echo "Executing: $PKGCMD"
                    logger -t Install "Executing: $PKGCMD"
                    eval $PKGCMD
                    if [ $? != 0 ]; then
                        echo "Command [$PKGCMD] failed with status $?"
                        logger -t Install "Command [$PKGCMD] failed with status $?"
                        exit $?
                    fi
                    logger -t Install "Command [$PKGCMD] succeeded"
                fi
            done
        fi
    else
        logger -t Install "No provisioning manifest found"
    fi
    
    logger -t Install "webapi_example dependencies installed successfully"
}

function post_install {
    echo "post_install"
    logger -t Install "webapi_example post-install starting"
    
    # Extract port from config if it exists
    if [ -f "$CONFIG_FILE" ]; then
        PORT=$(python3 -c "
import json
try:
    with open('$CONFIG_FILE') as f:
        config = json.load(f)
    print(config.get('server', {}).get('port', $DEFAULT_PORT))
except:
    print($DEFAULT_PORT)
" 2>/dev/null || echo $DEFAULT_PORT)
    else
        PORT=$DEFAULT_PORT
    fi

    echo "webapi_example: Opening firewall port $PORT via API..."
    logger -t Install "Opening firewall port $PORT via API"

    # Create firewall rule via mPower API (localhost requests work without login)
    FILTER_NAME="webapi_example_port_$PORT"
    
    # Check if firewall rule already exists
    EXISTING=$(curl -k -s "https://127.0.0.1/api/filters" 2>/dev/null)
    logger -t Install "Existing filters response: $EXISTING"
    
    if echo "$EXISTING" | grep -q "$FILTER_NAME"; then
        echo "webapi_example: Firewall rule '$FILTER_NAME' already exists"
        logger -t Install "Firewall rule '$FILTER_NAME' already exists"
    else
        # Create the firewall rule (include __v version field required by API, version 2 for current mLinux 7)
        FILTER_JSON="{\"__v\":2,\"name\":\"$FILTER_NAME\",\"description\":\"Allow inbound TCP to webapi_example port $PORT\",\"enabled\":true,\"chain\":\"INPUT\",\"target\":\"ACCEPT\",\"protocol\":\"TCP\",\"srcAddr\":\"ANY\",\"srcMask\":\"\",\"srcPort\":\"ANY\",\"dstAddr\":\"ANY\",\"dstMask\":\"\",\"dstPort\":\"$PORT\",\"srcInterface\":\"ANY\",\"dstInterface\":\"ANY\",\"srcSpecInterface\":\"\",\"dstSpecInterface\":\"\",\"srcMac\":\"ANY\"}"
        
        RESULT=$(curl -k -s -X POST "https://127.0.0.1/api/filters" \
            -H "Content-Type: application/json" \
            -d "$FILTER_JSON" 2>/dev/null)
        
        logger -t Install "Create filter result: $RESULT"
        
        if echo "$RESULT" | grep -q '"status" : "success"'; then
            echo "webapi_example: Firewall rule created for port $PORT"
            logger -t Install "Firewall rule created for port $PORT"
            
            # Save and apply configuration to persist and activate firewall rules
            curl -k -s -X POST "https://127.0.0.1/api/command/save_apply" -H "Content-Length: 0" 2>/dev/null
            logger -t Install "Configuration saved and applied"
        else
            echo "webapi_example: Failed to create firewall rule via API, falling back to iptables"
            logger -t Install "Failed to create firewall rule via API: $RESULT"
            
            # Fallback to iptables
            if ! iptables -C INPUT -p tcp --dport "$PORT" -j ACCEPT 2>/dev/null; then
                iptables -I INPUT -p tcp --dport "$PORT" -j ACCEPT
                echo "webapi_example: Firewall rule added via iptables for port $PORT"
                logger -t Install "Firewall rule added via iptables for port $PORT"
            fi
        fi
    fi
    
    logger -t Install "webapi_example post-install completed"
}

function remove_packages {
    logger -t Install "Removing webapi_example dependencies"
    
    if [ -f "$MANIFEST" ]; then
        JSONTXT=$(<./provisioning/p_manifest.json)
        PKGCNT=$(echo $JSONTXT | jsparser --count -p /pkgs 2>/dev/null)
        
        if [ -n "$PKGCNT" ] && [ "$PKGCNT" -gt 0 ]; then
            for ((i=0; i < PKGCNT; i++)); do
                PKG=$(echo $JSONTXT | jsparser --jsobj -p /pkgs/$i 2>/dev/null)
                PKGNM=$(echo $PKG | jsparser -p /PkgName 2>/dev/null)
                PKGTYPE=$(echo $PKG | jsparser -p /type 2>/dev/null)
                
                if [ "$PKGTYPE" == "ipk" ]; then
                    # Don't remove sqlite3 as other apps might use it
                    echo "Skipping removal of $PKGNM (shared package)"
                    logger -t Install "Skipping removal of $PKGNM (shared package)"
                fi
            done
        fi
    fi
    
    logger -t Install "webapi_example dependencies removal completed"
}

function post_remove {
    echo "post_remove"
    logger -t Install "webapi_example post-remove completed"
}

case "$1" in
    install)
        echo -n "Installing dependencies: "
        logger -t Install "Installing Dependencies: "
        install_packages
        echo "$NAME."
        ;;
    remove)
        echo -n "Removing Dependencies: "
        logger -t Install "Removing Dependencies: "
        remove_packages
        echo "$NAME."
        ;;
    postinstall)
        echo -n "Running app post install "
        logger -t Install "Running app post install "
        post_install
        echo "$NAME."
        ;;
    postremove)
        echo -n "Running app post remove "
        logger -t Install "Running app post remove "
        post_remove
        echo "$NAME."
        ;;
    *)
        N=$NAME
        echo "Usage: $N {install|remove|postinstall|postremove}" >&2
        exit 1
        ;;
esac

exit 0
